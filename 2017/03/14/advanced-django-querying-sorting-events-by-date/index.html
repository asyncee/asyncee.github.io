<html>

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name='yandex-verification' content='4db6105a4cf78b07' />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
    <meta name="description" content="Продвинутые запросы в Django: сортировка событий по дате — Пример сложной сортировки в Django с применением Case−When">
    <meta property="og:title" content="Продвинутые запросы в Django: сортировка событий по дате"/>
    <meta property="og:description" content="Пример сложной сортировки в Django с применением Case−When"/>
    <meta property="og:url" content= "http://asyncee.github.io/2017/03/14/advanced-django-querying-sorting-events-by-date/" />
    <meta property="og:image" content= "http://asyncee.github.io/public/favicon192.png" />
    <meta property="og:type" content="article"/>
    <meta property="og:locale" content= "ru_RU" />
    <meta property="og:article:author" content= "Stanislav Lobanov" />
    <meta property="og:article:published_time" content= "2017-03-14 00:00:00 +0300" />
  

  <title>
    
      Продвинутые запросы в Django: сортировка событий по дате &middot; Asyncee
    
  </title>

  <!-- CSS -->
  <link type="text/css" rel="stylesheet" href="/assets/main-aaa5d9ad510085a3a70a411b7eb9f873e4205b6320a2f538ac6eb731733805d6.css">

  <!-- js -->
  <script type="text/javascript" src="/assets/main-057f0c0975cf656bb1fc97caa0fbd4c2b88fb7042b3428cd656d6ca42d6bb0ac.js"></script>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/favicon144.png">
  <link rel="shortcut icon" href="/public/favicon32.png">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">

    <a href="/" class="sidebar-avatar">
      <div class="avatar">
        <img class="avatar__image" src="/public/avatar/avatar.jpg">
      </div>
    </a>

    <div class="sidebar-about">
      <h1>
        <a href="/">
          Asyncee
        </a>
      </h1>
      <p class="lead">Lobanov Stanislav</p>
    </div>

    <nav class="sidebar-nav">

      
      
        
          
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
    </nav>

  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Продвинутые запросы в Django: сортировка событий по дате</h1>
  <span class="post-date">Опубликовано

14
Марта
  
2017
</span>
  <p>Представьте ситуацию, в которой в нашем приложении были бы события (запланированные задачи, встречи, Python−конференции по всему миру), происходящие в разные моменты времени. Мы хотели бы отображать их пользователю в виде простого списка. Учитывая, что мы в Феврале 2017 года, какой способ сортировки событий был бы лучшим с точки зрения пользователя?</p>

<p><img src="/public/posts/advanced-django-querying/chronological.png" alt="хронологический порядок событий" /></p>

<p>Чтобы было проще ответить, мы можем немного изменить вопрос: какое событие из списка было бы наиболее значимо для пользователя? Я полагаю, что хороший ответ — ближайшее предстоящее мероприятие <strong>DjangoCon Europe</strong>. Круто, покажем его первым. Какое событие второе по значимости? Ну, учитывая, что <strong>PyCamp Argentina</strong> и <strong>PyCon Brasil</strong> давно прошли, то хорошим выбором была бы конференция <strong>PyCon US</strong>. У нас осталось два прошедших события, какое из них должно идти следующим? По моему личному мнению, самые недавние события должны быть первыми, чем старее событие, тем оно менее важно. Итак, вот какой порядок мы придумали в итоге:</p>

<p><img src="/public/posts/advanced-django-querying/best.png" alt="лучший порядок событий" /></p>

<p>Давайте взглянем поближе, что мы сделали. Сначала идут предстоящие события, упорядоченные хронологически (т.е. по порядку наступления), а затем прошедшие события, упорядоченные в обратном хронологическом порядке. Странно.</p>

<p><img src="/public/posts/advanced-django-querying/chronological_directions.png" alt="хронологические направления" /></p>

<p>Хорошо, и как нам теперь построить запрос в базу данных, чтобы отобразить эти события во вьюхе Django?</p>

<h2 id="Простой-подход">Простой подход</h2>

<p>Простым решением было бы написать два отдельных запроса и соединить результаты. Вот, как это могло бы выглядеть:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">myapp.models</span> <span class="kn">import</span> <span class="n">Event</span>

<span class="k">class</span> <span class="nc">EventListView</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">upcoming</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">date__gte</span><span class="o">=</span><span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'date'</span><span class="p">)</span>
        <span class="n">passed</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">date__lt</span><span class="o">=</span><span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-date'</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">upcoming</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
</code></pre>
</div>

<p>Главная проблема здесь то, что выполняя эти два запроса, мы извлекаем ВСЕ события из базы. Это станет проблемой, как только у нас появится много событий. Обычным решением является разбиение на страницы, но в данном случае пагинация не поможет. Нам всегда придётся выполнить оба запроса заранее, чтобы составить из них единый список, и только потом сделать срез (slice) списка для формирования страницы.</p>

<h2 id="Правильный-подход">Правильный подход</h2>

<p>Нам нужен способ вернуть события в правильном порядке за один запрос. Чтобы этого достигнуть, нам нужно использовать более продвинутые возможности Django ORM. Мы разобьём решение на две части. В первой, мы отделим грядущие события от прошедших и заставим будущие события отображаться в начале списка.</p>

<p>Мы воспользуемся операторами Django QuerySet <code class="highlighter-rouge">Case</code> и <code class="highlighter-rouge">When</code>. В этом посте я не затрону их подробно, так что, если вы не знаете как их использовать, рекомендую прочитать <a href="https://micropyramid.com/blog/django-conditional-expression-in-queries/">этот блогпост</a>. Также мы используем <code class="highlighter-rouge">annotations</code>. (<a href="https://docs.djangoproject.com/en/1.10/topics/db/aggregation/#generating-aggregates-for-each-item-in-a-queryset">читайте в документации Django</a>).</p>

<p>Вот первая часть нашего запроса:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">now</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="n">relevance</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Case</span><span class="p">(</span>
        <span class="n">models</span><span class="o">.</span><span class="n">When</span><span class="p">(</span><span class="n">date__gte</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">then</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">models</span><span class="o">.</span><span class="n">When</span><span class="p">(</span><span class="n">date__lt</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">then</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">output_field</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(),</span>
    <span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'relevance'</span><span class="p">))</span>
</code></pre>
</div>

<p>Мы аннотируем предстоящие события релевантностью <code class="highlighter-rouge">relevance = 1</code>и прошедшие <code class="highlighter-rouge">relevance = 2</code>. Когда мы упорядочиваем запрос по релевантности, будущие события располагаются перед прошедшими:</p>

<p><img src="/public/posts/advanced-django-querying/intermediary.png" alt="промежуточная сортировка" /></p>

<p>Выглядит неплохо, но мы ещё не закончили. Ближайшие события показываются в правильном порядке, а прошедшие в обратном. Вторая часть немного сложнее, так как предстоящие события идут в <em>порядке возрастания даты</em>, а прошедшие — <em>в порядке убывания</em>. Решение такое — аннотировать разницу во времени между текущей датой и датой события.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">now</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="n">relevance</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Case</span><span class="p">(</span>
        <span class="n">models</span><span class="o">.</span><span class="n">When</span><span class="p">(</span><span class="n">date__gte</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">then</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">models</span><span class="o">.</span><span class="n">When</span><span class="p">(</span><span class="n">date__lt</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">then</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">output_field</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(),</span>
    <span class="p">))</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="n">timediff</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Case</span><span class="p">(</span>
        <span class="n">models</span><span class="o">.</span><span class="n">When</span><span class="p">(</span><span class="n">date__gte</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">then</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s">'date'</span><span class="p">)</span> <span class="o">-</span> <span class="n">now</span><span class="p">),</span>
        <span class="n">models</span><span class="o">.</span><span class="n">When</span><span class="p">(</span><span class="n">date__lt</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">then</span><span class="o">=</span><span class="n">now</span> <span class="o">-</span> <span class="n">F</span><span class="p">(</span><span class="s">'date'</span><span class="p">)),</span>
        <span class="n">output_field</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">DurationField</span><span class="p">(),</span>
    <span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'relevance'</span><span class="p">,</span> <span class="s">'timediff'</span><span class="p">))</span>
</code></pre>
</div>

<p>Обратите внимание, что предстоящие события аннотированы как <code class="highlighter-rouge">дата события - текущая дата</code>, а прошедшие как <code class="highlighter-rouge">текущая дата - дата события</code>. Когда мы используем поле <code class="highlighter-rouge">timediff</code> как второй параметр сортировки <code class="highlighter-rouge">order_by</code>, то предстоящие события будут возвращены в хронологическом порядке, а прошедшие — в обратном хронологическом порядке.</p>

<p>Ура! Миссия выполнена, теперь мы можем получить все события в правильном порядке за один запрос в базу данных. К нему может быть применена пагинация, а значит он будет хорошо масштабироваться.</p>

<p>Эта статья является переводом статьи <strong>Filipe Ximenes</strong> <a href="https://www.vinta.com.br/blog/2017/advanced-django-querying-sorting-events-date/">Advanced Django querying: sorting events by date</a>. Перевод размещён с разрешения автора.</p>

</div>

<div id="disqus_thread"></div>
<script>

var disqus_config = function () {
this.page.url = "http://asyncee.github.io/2017/03/14/advanced-django-querying-sorting-events-by-date/";  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = "/2017/03/14/advanced-django-querying-sorting-events-by-date/"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//asyncee-github-io.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


    </div>

        <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
        (function (d, w, c) {
            (w[c] = w[c] || []).push(function() {
                try {
                    w.yaCounter36001570 = new Ya.Metrika({
                        id:36001570,
                        clickmap:true,
                        trackLinks:true,
                        accurateTrackBounce:true,
                        webvisor:true
                    });
                } catch(e) { }
            });

            var n = d.getElementsByTagName("script")[0],
                s = d.createElement("script"),
                f = function () { n.parentNode.insertBefore(s, n); };
            s.type = "text/javascript";
            s.async = true;
            s.src = "https://mc.yandex.ru/metrika/watch.js";

            if (w.opera == "[object Opera]") {
                d.addEventListener("DOMContentLoaded", f, false);
            } else { f(); }
        })(document, window, "yandex_metrika_callbacks");
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/36001570" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->


    <!-- JS -->
    <script async src="/public/js/medium-zoom.min.js" onload="initMediumZoom()"></script>
    <link href="https://fonts.googleapis.com/css?family=Abril+Fatface|Lora:400,400i,700|Roboto:500|Roboto+Mono&amp;subset=cyrillic" rel="stylesheet">
  </body>
</html>
